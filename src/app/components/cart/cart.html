<div class="cart-page section">
    <div class="container">
        <h1 class="h2 text-center mb-4">Votre Panier</h1>

        @if (orderSuccess) {
        <div class="success-banner mb-4">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <p>Merci pour votre commande ! Je viens de recevoir votre demande par mail.</p>
        </div>
        }

        @if (cartItems.length > 0) {
        <div class="cart-container">
            <div class="cart-items">
                @for (item of cartItems; track item.product.id) {
                <div class="cart-item">
                    <img [src]="item.product.image" [alt]="item.product.type" class="item-image"
                        [routerLink]="['/product', item.product.id]">
                    <div class="item-details" [routerLink]="['/product', item.product.id]">
                        <h3 class="h4">{{ item.product.type }}</h3>
                        <p class="brand">{{ item.product.brand }}</p>
                        <p class="price">
                            @if (item.product.price) {
                            {{ item.product.price }} {{ item.product.price.includes('€') ? '' : '€' }}
                            } @else {
                            -- €
                            }
                        </p>
                    </div>
                    <div class="item-quantity">
                        <div class="quantity-controls">
                            <button class="qty-btn" (click)="decrementQuantity(item)"
                                [disabled]="item.quantity === 1">−</button>
                            <span class="qty-value">{{ item.quantity }}</span>
                            <button class="qty-btn" (click)="incrementQuantity(item)">+</button>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-remove" (click)="removeItem(item)" title="Supprimer">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
                }
            </div>

            <div class="cart-summary">
                <div class="summary-card">
                    <h3 class="h4">Récapitulatif</h3>
                    <div class="total-row">
                        <span>Total</span>
                        <span class="total-price">{{ total }}€</span>
                    </div>

                    <div class="checkout-form-container">
                        <h4 class="h4 mb-3">Finaliser la commande</h4>

                        <div class="checkout-notice mb-4">
                            <strong>Imaginons votre futur accessoire ensemble...</strong>
                            <p>
                                Chaque création sortant de mon atelier est unique. En plaçant cet article dans votre
                                panier, vous m'informez de votre intérêt pour ce modèle. Ce n'est pas un achat immédiat
                                : <em>c'est le point de départ de notre échange !</em>
                            </p>
                            <p>
                                Je vous recontacterai rapidement pour convenir avec vous des matériaux et finitions
                                souhaitées afin de valider votre commande personnalisée.
                            </p>
                        </div>
                        <form action="https://formsubmit.co/la.marque.y.est@gmail.com" method="POST" id="checkout-form"
                            ngNoForm>
                            <input type="hidden" name="_template" value="box">
                            <input type="hidden" name="_subject" value="Nouvelle commande - La Marque y Est">
                            <input type="hidden" name="_autoresponse"
                                value="Merci pour votre commande sur La Marque y Est ! J'ai bien reçu votre demande et je vous recontacterai très prochainement pour finaliser le paiement et l'envoi.">
                            <input type="hidden" name="_next" [value]="getCartSuccessUrl()">

                            <!-- User Details -->
                            <div class="form-group mb-2">
                                <input type="text" name="name" placeholder="Nom complet" required class="form-input"
                                    [(ngModel)]="orderData.name">
                            </div>
                            <div class="form-group mb-2">
                                <input type="email" name="email" placeholder="Email" required class="form-input"
                                    [(ngModel)]="orderData.email">
                            </div>
                            <div class="form-group mb-2">
                                <input type="tel" name="phone" placeholder="Téléphone" required class="form-input"
                                    [(ngModel)]="orderData.phone">
                            </div>
                            <div class="form-group mb-2">
                                <input type="text" name="street" placeholder="Numéro et rue / voie" required
                                    class="form-input" [(ngModel)]="orderData.street">
                            </div>
                            <div class="form-group mb-2" style="display: flex; gap: 1rem;">
                                <input type="text" name="zipCode" placeholder="Code Postal" required class="form-input"
                                    style="flex: 1;" [(ngModel)]="orderData.zipCode">
                                <input type="text" name="city" placeholder="Ville" required class="form-input"
                                    style="flex: 2;" [(ngModel)]="orderData.city">
                            </div>
                            <div class="form-group mb-2">
                                <input type="text" name="country" placeholder="Pays" required class="form-input"
                                    [(ngModel)]="orderData.country">
                            </div>
                            <div class="form-group mb-3">
                                <textarea name="message" placeholder="Un message ou une précision ? (Optionnel)"
                                    class="form-input" rows="2"></textarea>
                            </div>

                            <div class="form-group"
                                style="display: flex; align-items: flex-start; gap: 0.8rem; margin-bottom: 1.5rem;">
                                <input type="checkbox" id="cgv-consent-cart" name="cgv_consent" required #cgvCheckbox
                                    (change)="true" style="margin-top: 4px; width: auto; cursor: pointer;">
                                <label for="cgv-consent-cart"
                                    style="font-size: 0.85rem; font-weight: 500; cursor: pointer; color: #555; line-height: 1.4; margin-bottom: 0;">
                                    J'accepte les CGV et je reconnais que les produits personnalisés ne sont pas soumis
                                    au droit de rétractation.
                                </label>
                            </div>

                            <!-- Hidden Cart Details -->
                            <input type="hidden" name="Detail_Commande" [value]="getCartSummaryForEmail()">

                            <button type="submit" class="btn btn-primary btn-full"
                                [disabled]="!cgvCheckbox.checked || !orderData.name || !orderData.email || !orderData.phone || !orderData.street || !orderData.zipCode || !orderData.city || !orderData.country"
                                [style.opacity]="(cgvCheckbox.checked && orderData.name && orderData.email && orderData.phone && orderData.street && orderData.zipCode && orderData.city && orderData.country) ? 1 : 0.5">Confirmer
                                la commande</button>
                        </form>
                    </div>

                    <button (click)="clearCart()" class="btn btn-outline btn-full mt-3">Vider le panier</button>
                </div>
            </div>
        </div>
        } @else {
        <div class="empty-state">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <path d="M16 10a4 4 0 0 1-8 0"></path>
                </svg>
            </div>
            <h3 class="h4">Votre panier est vide</h3>
            <p class="text-muted">Il semblerait que vous n'ayez pas encore trouvé votre bonheur.</p>
            <a routerLink="/" class="btn btn-primary">Découvrir nos créations</a>
        </div>
        }
    </div>
</div>